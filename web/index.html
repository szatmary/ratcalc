<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ratcalc</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #1e1e2e;
  color: #cdd6f4;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  overflow: hidden;
  height: 100vh;
}
#giowindow {
  position: fixed;
  top: 39px;
  left: 0;
  width: 100%;
  height: calc(100vh - 39px);
}
nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  display: flex;
  background: #181825;
  border-bottom: 1px solid #313244;
}
nav button {
  background: none;
  border: none;
  color: #6c7086;
  padding: 10px 20px;
  font-size: 14px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: color 0.15s, border-color 0.15s;
}
nav button:hover { color: #cdd6f4; }
nav button.active {
  color: #cdd6f4;
  border-bottom-color: #89b4fa;
}
#tab-lang {
  position: fixed;
  top: 39px;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
  overflow-y: auto;
  padding: 24px 32px;
  background: #1e1e2e;
  display: none;
}
#tab-lang .markdown {
  max-width: 800px;
  margin: 0 auto;
  line-height: 1.6;
}
#tab-lang h1 { font-size: 1.8em; margin: 0 0 16px; color: #cdd6f4; }
#tab-lang h2 { font-size: 1.3em; margin: 24px 0 12px; color: #cdd6f4; border-bottom: 1px solid #313244; padding-bottom: 6px; }
#tab-lang h3 { font-size: 1.1em; margin: 20px 0 8px; color: #cdd6f4; }
#tab-lang p { margin: 8px 0; }
#tab-lang code {
  background: #313244;
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 0.9em;
}
#tab-lang pre {
  background: #11111b;
  padding: 14px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 10px 0;
}
#tab-lang pre code { background: none; padding: 0; }
#tab-lang table {
  border-collapse: collapse;
  margin: 10px 0;
  width: 100%;
}
#tab-lang th, #tab-lang td {
  border: 1px solid #313244;
  padding: 6px 12px;
  text-align: left;
}
#tab-lang th { background: #181825; }
#tab-lang ul, #tab-lang ol { padding-left: 24px; margin: 8px 0; }
#tab-lang li { margin: 4px 0; }
#tab-lang strong { color: #f5c2e7; }
#tab-lang blockquote {
  border-left: 3px solid #89b4fa;
  padding-left: 12px;
  color: #a6adc8;
  margin: 8px 0;
}
</style>
</head>
<body>
<nav>
  <button class="active" onclick="showTab('calc')">Calculator</button>
  <button onclick="showTab('lang')">Language</button>
  <button onclick="shareLink()">Share</button>
  <button onclick="window.open('https://github.com/szatmary/ratcalc','_blank')">GitHub</button>
</nav>
<div id="giowindow"></div>
<div id="tab-lang"><div class="markdown" id="lang-content"></div></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
function showTab(tab) {
  document.getElementById('tab-lang').style.display = tab === 'lang' ? 'block' : 'none';
  document.querySelectorAll('nav button').forEach((btn, i) => {
    btn.classList.toggle('active', (i === 0 && tab === 'calc') || (i === 1 && tab === 'lang'));
  });
}

fetch('LANGUAGE.md')
  .then(r => r.text())
  .then(md => { document.getElementById('lang-content').innerHTML = marked.parse(md); });
</script>
<script>
// --- Keyboard shortcut handling ---
// Gio on WASM maps Ctrl (not Cmd/Meta) to ModShortcut. macOS browser
// users press Cmd for shortcuts. We intercept in the capturing phase,
// prevent browser defaults, and for Cmd+key re-dispatch as Ctrl+key
// so Gio recognizes them. Paste is handled entirely in JS.
var shortcutKeys = ['a','c','x','z','y','s','o'];
var shortcutSymbols = ['=','-','+'];

document.addEventListener('keydown', function(e) {
  if (document.getElementById('tab-lang').style.display !== 'none') return;
  var mod = e.ctrlKey || e.metaKey;
  if (!mod) return;
  var k = e.key.toLowerCase();
  var input = document.querySelector('#giowindow input');

  // Handle paste entirely in JS (Gio's Clipboard API call fails on web)
  if (k === 'v') {
    e.preventDefault();
    e.stopImmediatePropagation();
    navigator.clipboard.readText().then(function(text) {
      if (!text || !input) return;
      input.value = text;
      input.dispatchEvent(new Event('input', { bubbles: true }));
    }).catch(function() {});
    return;
  }

  // Prevent browser defaults for our shortcuts
  if (shortcutKeys.includes(k) || shortcutSymbols.includes(e.key)) {
    e.preventDefault();
  }

  // Convert Cmd+key to Ctrl+key so Gio sees ModShortcut
  if (e.metaKey && !e.ctrlKey && input) {
    e.stopImmediatePropagation();
    input.dispatchEvent(new KeyboardEvent('keydown', {
      key: e.key, code: e.code,
      ctrlKey: true, shiftKey: e.shiftKey, altKey: e.altKey,
      bubbles: true, cancelable: true,
    }));
  }
}, true);

// Fallback paste handler for right-click paste
document.addEventListener('paste', function(e) {
  if (document.getElementById('tab-lang').style.display !== 'none') return;
  var text = (e.clipboardData || window.clipboardData).getData('text');
  if (!text) return;
  var input = document.querySelector('#giowindow input');
  if (input) {
    input.value = text;
    input.dispatchEvent(new Event('input', { bubbles: true }));
  }
  e.stopImmediatePropagation();
  e.preventDefault();
}, true);

// --- Share link ---
function base64urlEncode(data) {
  var binary = '';
  for (var i = 0; i < data.length; i++) binary += String.fromCharCode(data[i]);
  return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}
function base64urlDecode(str) {
  str = str.replace(/-/g, '+').replace(/_/g, '/');
  while (str.length % 4) str += '=';
  var binary = atob(str);
  var data = new Uint8Array(binary.length);
  for (var i = 0; i < binary.length; i++) data[i] = binary.charCodeAt(i);
  return data;
}
async function compress(text) {
  var cs = new CompressionStream('deflate-raw');
  var writer = cs.writable.getWriter();
  writer.write(new TextEncoder().encode(text));
  writer.close();
  var chunks = [], reader = cs.readable.getReader();
  while (true) {
    var r = await reader.read();
    if (r.done) break;
    chunks.push(r.value);
  }
  var len = chunks.reduce(function(a, c) { return a + c.length; }, 0);
  var out = new Uint8Array(len), off = 0;
  chunks.forEach(function(c) { out.set(c, off); off += c.length; });
  return out;
}
async function decompress(data) {
  var ds = new DecompressionStream('deflate-raw');
  var writer = ds.writable.getWriter();
  writer.write(data);
  writer.close();
  var chunks = [], reader = ds.readable.getReader();
  while (true) {
    var r = await reader.read();
    if (r.done) break;
    chunks.push(r.value);
  }
  var len = chunks.reduce(function(a, c) { return a + c.length; }, 0);
  var out = new Uint8Array(len), off = 0;
  chunks.forEach(function(c) { out.set(c, off); off += c.length; });
  return new TextDecoder().decode(out);
}
async function shareLink() {
  if (typeof getEditorText !== 'function') return;
  var text = getEditorText();
  if (!text) return;
  var compressed = await compress(text);
  var encoded = base64urlEncode(compressed);
  var url = window.location.origin + window.location.pathname + '?t=' + encoded;
  await navigator.clipboard.writeText(url);
  alert('Link copied to clipboard');
}
</script>
<script src="wasm_exec.js"></script>
<script>
// Decode URL parameter before WASM loads so Go can read it on init
(async function() {
  var params = new URLSearchParams(window.location.search);
  var encoded = params.get('t');
  if (encoded) {
    try {
      window._initialText = await decompress(base64urlDecode(encoded));
    } catch(e) { console.error('Failed to decode shared text:', e); }
  }
  var go = new Go();
  var result = await WebAssembly.instantiateStreaming(
    fetch("ratcalc.wasm"), go.importObject
  );
  go.run(result.instance);
})();
</script>
</body>
</html>
