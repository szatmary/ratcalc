<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ratcalc</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #1e1e2e;
  color: #cdd6f4;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  overflow: hidden;
  height: 100vh;
}
nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  display: flex;
  background: #181825;
  border-bottom: 1px solid #313244;
}
nav button {
  background: none;
  border: none;
  color: #6c7086;
  padding: 10px 20px;
  font-size: 14px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: color 0.15s, border-color 0.15s;
}
nav button:hover { color: #cdd6f4; }
nav button.active {
  color: #cdd6f4;
  border-bottom-color: #89b4fa;
}

/* --- Calculator layout --- */
#calc-container {
  position: fixed;
  top: 39px;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  overflow: hidden;
}
#line-numbers {
  width: 48px;
  min-width: 48px;
  background: #181825;
  color: #585b70;
  font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, Consolas, monospace;
  font-size: 14px;
  line-height: 21px;
  padding: 8px 8px 8px 0;
  text-align: right;
  overflow: hidden;
  user-select: none;
  border-right: 1px solid #313244;
}
#line-numbers div {
  height: 21px;
  white-space: nowrap;
}
#editor {
  flex: 1;
  background: #1e1e2e;
  color: #cdd6f4;
  font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, Consolas, monospace;
  font-size: 14px;
  line-height: 21px;
  padding: 8px 12px;
  border: none;
  outline: none;
  resize: none;
  overflow-y: auto;
  overflow-x: hidden;
  white-space: pre;
  tab-size: 4;
}
#results {
  width: 280px;
  min-width: 280px;
  background: #181825;
  font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, Consolas, monospace;
  font-size: 14px;
  line-height: 21px;
  padding: 8px 12px;
  overflow: hidden;
  user-select: text;
  border-left: 1px solid #313244;
}
#results div {
  height: 21px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #a6e3a1;
}
#results div.err {
  color: #f38ba8;
}

/* --- Language tab --- */
#tab-lang {
  position: fixed;
  top: 39px;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
  overflow-y: auto;
  padding: 24px 32px;
  background: #1e1e2e;
  display: none;
}
#tab-lang .markdown {
  max-width: 800px;
  margin: 0 auto;
  line-height: 1.6;
}
#tab-lang h1 { font-size: 1.8em; margin: 0 0 16px; color: #cdd6f4; }
#tab-lang h2 { font-size: 1.3em; margin: 24px 0 12px; color: #cdd6f4; border-bottom: 1px solid #313244; padding-bottom: 6px; }
#tab-lang h3 { font-size: 1.1em; margin: 20px 0 8px; color: #cdd6f4; }
#tab-lang p { margin: 8px 0; }
#tab-lang code {
  background: #313244;
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 0.9em;
}
#tab-lang pre {
  background: #11111b;
  padding: 14px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 10px 0;
}
#tab-lang pre code { background: none; padding: 0; }
#tab-lang table {
  border-collapse: collapse;
  margin: 10px 0;
  width: 100%;
}
#tab-lang th, #tab-lang td {
  border: 1px solid #313244;
  padding: 6px 12px;
  text-align: left;
}
#tab-lang th { background: #181825; }
#tab-lang ul, #tab-lang ol { padding-left: 24px; margin: 8px 0; }
#tab-lang li { margin: 4px 0; }
#tab-lang strong { color: #f5c2e7; }
#tab-lang blockquote {
  border-left: 3px solid #89b4fa;
  padding-left: 12px;
  color: #a6adc8;
  margin: 8px 0;
}
</style>
</head>
<body>
<nav>
  <button class="active" onclick="showTab('calc')">Calculator</button>
  <button onclick="showTab('lang')">Language</button>
  <button onclick="shareLink()">Share</button>
  <button onclick="clearEditor()">Clear</button>
  <button onclick="window.open('https://github.com/szatmary/ratcalc','_blank')">GitHub</button>
</nav>
<div id="calc-container">
  <div id="line-numbers"><div>1</div></div>
  <textarea id="editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
  <div id="results"></div>
</div>
<div id="tab-lang"><div class="markdown" id="lang-content"></div></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// --- Tab switching ---
function showTab(tab) {
  document.getElementById('tab-lang').style.display = tab === 'lang' ? 'block' : 'none';
  document.getElementById('calc-container').style.display = tab === 'calc' ? 'flex' : 'none';
  document.querySelectorAll('nav button').forEach(function(btn, i) {
    btn.classList.toggle('active', (i === 0 && tab === 'calc') || (i === 1 && tab === 'lang'));
  });
  if (tab === 'calc') document.getElementById('editor').focus();
}

// --- Language spec ---
fetch('LANGUAGE.md')
  .then(function(r) { return r.text(); })
  .then(function(md) { document.getElementById('lang-content').innerHTML = marked.parse(md); });

// --- Editor evaluation ---
var editor = document.getElementById('editor');
var lineNumbers = document.getElementById('line-numbers');
var resultsDiv = document.getElementById('results');
var nowInterval = null;

function measureMaxChars() {
  if (typeof setMaxDisplayLen !== 'function') return;
  var style = getComputedStyle(resultsDiv);
  var canvas = document.createElement('canvas');
  var ctx = canvas.getContext('2d');
  ctx.font = style.fontSize + ' ' + style.fontFamily;
  var charW = ctx.measureText('0').width;
  var pad = parseFloat(style.paddingLeft) + parseFloat(style.paddingRight);
  var maxChars = Math.floor((resultsDiv.clientWidth - pad) / charW);
  if (maxChars > 0) setMaxDisplayLen(maxChars);
}
window.addEventListener('resize', measureMaxChars);

function runEval(nowTicked) {
  if (typeof evaluate !== 'function') return;
  var results = evaluate(editor.value, nowTicked);
  if (!results) return;

  var lines = editor.value.split('\n');
  var count = lines.length;

  // Update line numbers
  var lnHtml = '';
  for (var i = 1; i <= count; i++) {
    lnHtml += '<div>' + i + '</div>';
  }
  lineNumbers.innerHTML = lnHtml;

  // Update results
  var rHtml = '';
  for (var i = 0; i < results.length; i++) {
    var r = results[i];
    if (r.isErr) {
      rHtml += '<div class="err">' + escapeHtml(r.text) + '</div>';
    } else {
      rHtml += '<div>' + escapeHtml(r.text) + '</div>';
    }
  }
  resultsDiv.innerHTML = rHtml;
}

function clearEditor() {
  editor.value = '';
  try { localStorage.removeItem('ratcalc_text'); } catch(e) {}
  runEval(false);
  editor.focus();
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

editor.addEventListener('input', function() {
  runEval(false);
  try { localStorage.setItem('ratcalc_text', editor.value); } catch(e) {}
});

// --- Save as .txt with Cmd/Ctrl+S ---
document.addEventListener('keydown', function(e) {
  if ((e.metaKey || e.ctrlKey) && e.key === 's') {
    e.preventDefault();
    var blob = new Blob([editor.value], {type: 'text/plain'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ratcalc.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  }
});

// --- Scroll sync ---
editor.addEventListener('scroll', function() {
  lineNumbers.scrollTop = editor.scrollTop;
  resultsDiv.scrollTop = editor.scrollTop;
});

// --- Now() refresh every second ---
nowInterval = setInterval(function() {
  runEval(true);
}, 1000);

// --- Share link ---
function base64urlEncode(data) {
  var binary = '';
  for (var i = 0; i < data.length; i++) binary += String.fromCharCode(data[i]);
  return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}
function base64urlDecode(str) {
  str = str.replace(/-/g, '+').replace(/_/g, '/');
  while (str.length % 4) str += '=';
  var binary = atob(str);
  var data = new Uint8Array(binary.length);
  for (var i = 0; i < binary.length; i++) data[i] = binary.charCodeAt(i);
  return data;
}
function compress(text) {
  return zstdCompress(text);
}
function decompress(data) {
  return zstdDecompress(data);
}
function shareLink() {
  if (typeof getEditorText !== 'function') return;
  var text = getEditorText();
  if (!text) return;
  var compressed = compress(text);
  var encoded = base64urlEncode(compressed);
  var url = 'https://ratcalc.com/?t=' + encoded;
  navigator.clipboard.writeText(url);
  alert('Link copied to clipboard');
}
</script>
<script src="wasm_exec.js"></script>
<script>
// Decode URL parameter after WASM loads (zstd runs in WASM)
(async function() {
  var encodedParam = new URLSearchParams(window.location.search).get('t');

  window._onWasmReady = function() {
    if (encodedParam) {
      try {
        var text = decompress(base64urlDecode(encodedParam));
        if (text) editor.value = text;
      } catch(e) { console.error('Failed to decode shared text:', e); }
    } else {
      try {
        var saved = localStorage.getItem('ratcalc_text');
        if (saved) editor.value = saved;
      } catch(e) {}
    }
    measureMaxChars();
    runEval(false);
    editor.focus();
  };

  var go = new Go();
  var result = await WebAssembly.instantiateStreaming(
    fetch("ratcalc.wasm"), go.importObject
  );
  go.run(result.instance);
})();
</script>
</body>
</html>
