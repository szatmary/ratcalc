<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ratcalc</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #1e1e2e;
  color: #cdd6f4;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  overflow: hidden;
  height: 100vh;
}
nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  display: flex;
  background: #181825;
  border-bottom: 1px solid #313244;
}
nav button {
  background: none;
  border: none;
  color: #6c7086;
  padding: 10px 20px;
  font-size: 14px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: color 0.15s, border-color 0.15s;
}
nav button:hover { color: #cdd6f4; }
nav button.active {
  color: #cdd6f4;
  border-bottom-color: #89b4fa;
}

/* --- Calculator layout --- */
#calc-container {
  position: fixed;
  top: 39px;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  overflow: hidden;
}
#line-numbers {
  width: 48px;
  min-width: 48px;
  background: #181825;
  color: #585b70;
  font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, Consolas, monospace;
  font-size: 14px;
  line-height: 21px;
  padding: 8px 8px 8px 0;
  text-align: right;
  overflow: hidden;
  user-select: none;
  border-right: 1px solid #313244;
}
#line-numbers div {
  height: 21px;
  white-space: nowrap;
}
#editor-wrap {
  flex: 1;
  position: relative;
  overflow: hidden;
}
#highlight {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, Consolas, monospace;
  font-size: 14px;
  line-height: 21px;
  padding: 8px 12px;
  white-space: pre;
  tab-size: 4;
  overflow: hidden;
  pointer-events: none;
  color: #cdd6f4;
}
#highlight div {
  height: 21px;
}
#highlight .hl-line, #line-numbers .hl-line, #results .hl-line {
  background: rgba(255,255,255,0.04);
}
#editor {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: transparent;
  color: transparent;
  caret-color: #cdd6f4;
  font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, Consolas, monospace;
  font-size: 14px;
  line-height: 21px;
  padding: 8px 12px;
  border: none;
  outline: none;
  resize: none;
  overflow-y: auto;
  overflow-x: hidden;
  white-space: pre;
  tab-size: 4;
}
.tk-num   { color: #fab387; }
.tk-op    { color: #89dceb; }
.tk-paren { color: #f5c2e7; }
.tk-cur   { color: #f9e2af; }
.tk-unit  { color: #89b4fa; }
.tk-fn    { color: #cba6f7; }
.tk-ref   { color: #94e2d5; }
.tk-at    { color: #f5c2e7; }
.tk-time  { color: #f5c2e7; }
.tk-cmt   { color: #6c7086; }
.tk-eq    { color: #f38ba8; }
#results-wrapper {
  display: flex;
  width: 280px;
  min-width: 80px;
}
#results-drag {
  width: 5px;
  cursor: col-resize;
  background: #313244;
  flex-shrink: 0;
}
#results-drag:hover {
  background: #585b70;
}
#results {
  flex: 1;
  background: #181825;
  font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, Consolas, monospace;
  font-size: 14px;
  line-height: 21px;
  padding: 8px 12px;
  overflow: hidden;
  user-select: text;
}
#results div {
  height: 21px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #a6e3a1;
}
#results div.err {
  color: #f38ba8;
}

/* --- Language tab --- */
#tab-lang {
  position: fixed;
  top: 39px;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
  overflow-y: auto;
  padding: 24px 32px;
  background: #1e1e2e;
  display: none;
}
#tab-lang .markdown {
  max-width: 800px;
  margin: 0 auto;
  line-height: 1.6;
}
#tab-lang h1 { font-size: 1.8em; margin: 0 0 16px; color: #cdd6f4; }
#tab-lang h2 { font-size: 1.3em; margin: 24px 0 12px; color: #cdd6f4; border-bottom: 1px solid #313244; padding-bottom: 6px; }
#tab-lang h3 { font-size: 1.1em; margin: 20px 0 8px; color: #cdd6f4; }
#tab-lang p { margin: 8px 0; }
#tab-lang code {
  background: #313244;
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 0.9em;
}
#tab-lang pre {
  background: #11111b;
  padding: 14px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 10px 0;
}
#tab-lang pre code { background: none; padding: 0; }
#tab-lang table {
  border-collapse: collapse;
  margin: 10px 0;
  width: 100%;
}
#tab-lang th, #tab-lang td {
  border: 1px solid #313244;
  padding: 6px 12px;
  text-align: left;
}
#tab-lang th { background: #181825; }
#tab-lang ul, #tab-lang ol { padding-left: 24px; margin: 8px 0; }
#tab-lang li { margin: 4px 0; }
#tab-lang strong { color: #f5c2e7; }
#tab-lang blockquote {
  border-left: 3px solid #89b4fa;
  padding-left: 12px;
  color: #a6adc8;
  margin: 8px 0;
}

/* --- Forex modal --- */
#forex-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 2000;
}
#forex-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2001;
  background: #1e1e2e;
  border: 1px solid #313244;
  border-radius: 12px;
  padding: 28px 32px;
  max-width: 420px;
  text-align: center;
}
#forex-dialog p {
  margin: 0 0 12px;
  font-size: 15px;
  line-height: 1.5;
  color: #cdd6f4;
}
#forex-dialog a {
  display: inline-block;
  margin: 8px 0 20px;
  color: #89b4fa;
  font-size: 15px;
  text-decoration: none;
}
#forex-dialog a:hover { text-decoration: underline; }
#forex-dialog button {
  background: #313244;
  color: #cdd6f4;
  border: none;
  border-radius: 6px;
  padding: 8px 24px;
  font-size: 14px;
  cursor: pointer;
}
#forex-dialog button:hover { background: #45475a; }
</style>
</head>
<body>
<nav>
  <button class="active" onclick="showTab('calc')">Calculator</button>
  <button onclick="showTab('lang')">Language</button>
  <button onclick="shareLink()">Share</button>
  <button onclick="clearEditor()">Clear</button>
  <button onclick="window.open('https://github.com/szatmary/ratcalc','_blank')">GitHub</button>
</nav>
<div id="calc-container">
  <div id="line-numbers"><div>1</div></div>
  <div id="editor-wrap">
    <div id="highlight" aria-hidden="true"></div>
    <textarea id="editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
  </div>
  <div id="results-wrapper"><div id="results-drag"></div><div id="results"></div></div>
</div>
<div id="tab-lang"><div class="markdown" id="lang-content"></div></div>
<div id="forex-modal" style="display:none">
  <div id="forex-backdrop" onclick="document.getElementById('forex-modal').style.display='none'"></div>
  <div id="forex-dialog">
    <p>Realtime FOREX data not available.</p>
    <p>If you would like to see this feature, please consider sponsoring!</p>
    <a href="https://github.com/sponsors/szatmary" target="_blank" rel="noopener">github.com/sponsors/szatmary</a>
    <button onclick="document.getElementById('forex-modal').style.display='none'">Close</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// --- Tab switching ---
function showTab(tab) {
  document.getElementById('tab-lang').style.display = tab === 'lang' ? 'block' : 'none';
  document.getElementById('calc-container').style.display = tab === 'calc' ? 'flex' : 'none';
  document.querySelectorAll('nav button').forEach(function(btn, i) {
    btn.classList.toggle('active', (i === 0 && tab === 'calc') || (i === 1 && tab === 'lang'));
  });
  if (tab === 'calc') document.getElementById('editor').focus();
}

// --- Language spec ---
fetch('LANGUAGE.md')
  .then(function(r) { return r.text(); })
  .then(function(md) { document.getElementById('lang-content').innerHTML = marked.parse(md); });

// --- Editor evaluation ---
var editor = document.getElementById('editor');
var lineNumbers = document.getElementById('line-numbers');
var resultsDiv = document.getElementById('results');
var resultsWrapper = document.getElementById('results-wrapper');
var resultsDrag = document.getElementById('results-drag');
var highlightDiv = document.getElementById('highlight');
var nowInterval = null;

// --- Syntax highlighting ---
var TK = {
  NUMBER:0, WORD:1, PLUS:2, MINUS:3, STAR:4, SLASH:5,
  LPAREN:6, RPAREN:7, EQUALS:8, DOT:9, HASH:10, AT:11,
  COMMA:12, PERCENT:13, BANG:14, STARSTAR:15, AMP:16,
  PIPE:17, CARET:18, TILDE:19, LSHIFT:20, RSHIFT:21,
  CURRENCY:22, TIME:23, EOF:24
};
var FUNCTIONS = new Set(['sin','cos','tan','asin','acos','atan','sqrt','abs',
  'log','ln','log2','ceil','floor','round','pow','mod','atan2','min','max',
  'now','date','time','unix','num','fv','pv','year','month','day','hour','minute','second']);

var unitCache = {};
function cachedIsUnit(name) {
  if (name in unitCache) return unitCache[name];
  var result = (typeof isUnit === 'function') && isUnit(name);
  unitCache[name] = result;
  return result;
}

function tokenClass(type, literal, nextType) {
  switch(type) {
    case TK.NUMBER: return 'tk-num';
    case TK.CURRENCY: return 'tk-cur';
    case TK.LPAREN: case TK.RPAREN: return 'tk-paren';
    case TK.EQUALS: return 'tk-eq';
    case TK.AT: return 'tk-at';
    case TK.TIME: return 'tk-time';
    case TK.HASH: return 'tk-ref';
    case TK.PLUS: case TK.MINUS: case TK.STAR: case TK.SLASH:
    case TK.STARSTAR: case TK.AMP: case TK.PIPE: case TK.CARET:
    case TK.TILDE: case TK.LSHIFT: case TK.RSHIFT:
    case TK.PERCENT: case TK.BANG: case TK.COMMA: case TK.DOT:
      return 'tk-op';
    case TK.WORD:
      if (literal === 'to') return 'tk-op';
      if (FUNCTIONS.has(literal) && nextType === TK.LPAREN) return 'tk-fn';
      if (cachedIsUnit(literal)) return 'tk-unit';
      return '';
    default: return '';
  }
}

function byteToCharOffsets(line) {
  var enc = new TextEncoder();
  var map = [];
  var bytePos = 0;
  for (var i = 0; i < line.length; i++) {
    var charBytes = enc.encode(line[i]).length;
    for (var b = 0; b < charBytes; b++) {
      map[bytePos + b] = i;
    }
    bytePos += charBytes;
  }
  map[bytePos] = line.length;
  return map;
}

function buildHighlight(text, currentLine) {
  if (typeof tokenize !== 'function') return escapeHtml(text);
  var lines = text.split('\n');
  var tokenLines = tokenize(text);
  var html = '';
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    var cls = (i === currentLine) ? ' class="hl-line"' : '';
    var trimmed = line.trimStart();
    if (trimmed.charAt(0) === ';') {
      html += '<div' + cls + '><span class="tk-cmt">' + escapeHtml(line) + '</span></div>';
      continue;
    }
    var tokens = tokenLines[i];
    var b2c = byteToCharOffsets(line);
    var spans = '';
    var charPos = 0;
    for (var j = 0; j < tokens.length; j++) {
      var t = tokens[j];
      if (t.type === TK.EOF) break;
      var tCharStart = b2c[t.pos] !== undefined ? b2c[t.pos] : t.pos;
      if (tCharStart > charPos) {
        spans += escapeHtml(line.substring(charPos, tCharStart));
      }
      var nextType = (j+1 < tokens.length) ? tokens[j+1].type : TK.EOF;
      if (t.type === TK.HASH && j+1 < tokens.length && tokens[j+1].type === TK.NUMBER) {
        var numT = tokens[j+1];
        var numCharStart = b2c[numT.pos] !== undefined ? b2c[numT.pos] : numT.pos;
        var numCharEnd = numCharStart + numT.lit.length;
        spans += '<span class="tk-ref">' + escapeHtml(line.substring(tCharStart, numCharEnd)) + '</span>';
        charPos = numCharEnd;
        j++;
        continue;
      }
      var c = tokenClass(t.type, t.lit, nextType);
      var tCharEnd = tCharStart + t.lit.length;
      if (c) {
        spans += '<span class="' + c + '">' + escapeHtml(t.lit) + '</span>';
      } else {
        spans += escapeHtml(t.lit);
      }
      charPos = tCharEnd;
    }
    if (charPos < line.length) {
      spans += escapeHtml(line.substring(charPos));
    }
    html += '<div' + cls + '>' + (spans || ' ') + '</div>';
  }
  return html;
}

function getCurrentLine() {
  var pos = editor.selectionStart;
  var text = editor.value.substring(0, pos);
  return text.split('\n').length - 1;
}

function updateHighlight() {
  var cur = getCurrentLine();
  highlightDiv.innerHTML = buildHighlight(editor.value, cur);
  applyGutterHighlight();
}

function measureMaxChars() {
  if (typeof setMaxDisplayLen !== 'function') return;
  var style = getComputedStyle(resultsDiv);
  var canvas = document.createElement('canvas');
  var ctx = canvas.getContext('2d');
  ctx.font = style.fontSize + ' ' + style.fontFamily;
  var charW = ctx.measureText('0').width;
  var pad = parseFloat(style.paddingLeft) + parseFloat(style.paddingRight);
  var maxChars = Math.floor((resultsDiv.clientWidth - pad) / charW);
  if (maxChars > 0) setMaxDisplayLen(maxChars);
}
window.addEventListener('resize', measureMaxChars);
new ResizeObserver(function() { measureMaxChars(); runEval(false); }).observe(resultsWrapper);

function runEval(nowTicked) {
  if (typeof evaluate !== 'function') return;
  var results = evaluate(editor.value, nowTicked);
  if (!results) return;

  var lines = editor.value.split('\n');
  var count = lines.length;

  // Update line numbers
  var lnHtml = '';
  for (var i = 1; i <= count; i++) {
    lnHtml += '<div>' + i + '</div>';
  }
  lineNumbers.innerHTML = lnHtml;

  // Update results
  var rHtml = '';
  for (var i = 0; i < results.length; i++) {
    var r = results[i];
    if (r.isErr && r.text === '__forex__') {
      rHtml += '<div class="err" style="cursor:pointer" onclick="document.getElementById(\'forex-modal\').style.display=\'block\'">FOREX N/A</div>';
    } else if (r.isErr) {
      rHtml += '<div class="err">' + escapeHtml(r.text) + '</div>';
    } else {
      rHtml += '<div>' + escapeHtml(r.text) + '</div>';
    }
  }
  resultsDiv.innerHTML = rHtml;
  applyGutterHighlight();
}

function applyGutterHighlight() {
  var cur = getCurrentLine();
  var lnDivs = lineNumbers.children;
  var rsDivs = resultsDiv.children;
  for (var i = 0; i < lnDivs.length; i++) {
    lnDivs[i].classList.toggle('hl-line', i === cur);
  }
  for (var i = 0; i < rsDivs.length; i++) {
    rsDivs[i].classList.toggle('hl-line', i === cur);
  }
}

function clearEditor() {
  editor.value = '';
  try { localStorage.removeItem('ratcalc_text'); } catch(e) {}
  runEval(false);
  updateHighlight();
  editor.focus();
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

editor.addEventListener('input', function() {
  runEval(false);
  updateHighlight();
  try { localStorage.setItem('ratcalc_text', editor.value); } catch(e) {}
});
editor.addEventListener('click', updateHighlight);
editor.addEventListener('keyup', updateHighlight);
editor.addEventListener('mouseup', updateHighlight);
editor.addEventListener('select', updateHighlight);

// --- Save as .txt with Cmd/Ctrl+S ---
document.addEventListener('keydown', function(e) {
  if ((e.metaKey || e.ctrlKey) && e.key === 's') {
    e.preventDefault();
    var blob = new Blob([editor.value], {type: 'text/plain'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ratcalc.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  }
});

// --- Scroll sync ---
editor.addEventListener('scroll', function() {
  lineNumbers.scrollTop = editor.scrollTop;
  resultsDiv.scrollTop = editor.scrollTop;
  highlightDiv.scrollTop = editor.scrollTop;
});

// --- Drag to resize results gutter ---
(function() {
  var dragging = false, startX, startW;
  resultsDrag.addEventListener('mousedown', function(e) {
    dragging = true;
    startX = e.clientX;
    startW = resultsWrapper.offsetWidth;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });
  document.addEventListener('mousemove', function(e) {
    if (!dragging) return;
    var newW = startW - (e.clientX - startX);
    if (newW < 80) newW = 80;
    resultsWrapper.style.width = newW + 'px';
  });
  document.addEventListener('mouseup', function() {
    if (!dragging) return;
    dragging = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    measureMaxChars();
    runEval(false);
  });
})();

// --- Now() refresh every second ---
nowInterval = setInterval(function() {
  runEval(true);
}, 1000);

// --- Share link ---
function base64urlEncode(data) {
  var binary = '';
  for (var i = 0; i < data.length; i++) binary += String.fromCharCode(data[i]);
  return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}
function base64urlDecode(str) {
  str = str.replace(/-/g, '+').replace(/_/g, '/');
  while (str.length % 4) str += '=';
  var binary = atob(str);
  var data = new Uint8Array(binary.length);
  for (var i = 0; i < binary.length; i++) data[i] = binary.charCodeAt(i);
  return data;
}
function compress(text) {
  return zstdCompress(text);
}
function decompress(data) {
  return zstdDecompress(data);
}
function shareLink() {
  if (typeof getEditorText !== 'function') return;
  var text = getEditorText();
  if (!text) return;
  var compressed = compress(text);
  var encoded = base64urlEncode(compressed);
  var url = 'https://ratcalc.com/?t=' + encoded;
  navigator.clipboard.writeText(url);
  alert('Link copied to clipboard');
}
</script>
<script src="wasm_exec.js"></script>
<script>
// Decode URL parameter after WASM loads (zstd runs in WASM)
(async function() {
  var encodedParam = new URLSearchParams(window.location.search).get('t');

  window._onWasmReady = function() {
    if (encodedParam) {
      try {
        var text = decompress(base64urlDecode(encodedParam));
        if (text) editor.value = text;
      } catch(e) { console.error('Failed to decode shared text:', e); }
    } else {
      try {
        var saved = localStorage.getItem('ratcalc_text');
        if (saved) {
          editor.value = saved;
        } else {
          editor.value = [
            '; Welcome to ratcalc!',
            '; Exact rational arithmetic, units, dates & more.',
            '; Edit anything — your work auto-saves.',
            '',
            '; --- Dates & times ---',
            'now()',
            'now() to PST',
            '@2024-01-01',
            'now() - @2024-01-01 to d',
            '@1740000000',
            '',
            '; --- Unit conversions ---',
            '5 miles to km',
            '100 kg to lb',
            '72 F to C',
            '1 gallon to liters',
            '2 hr + 30 min to min',
            '1 year to weeks',
            '',
            '; --- Compound units ---',
            '100 km / 1 hr to mi/hr',
            '$240 / 1 hr to $/min',
            '',
            '; --- Basic math ---',
            '2 + 3',
            '1/3 + 1/6',
            '(7 + 3) * (10 - 4)',
            '2 ** 10',
            '10!',
            '',
            '; --- Variables ---',
            'price = 49.99',
            'qty = 3',
            'subtotal = price * qty',
            'tax = subtotal * 8.5%',
            'subtotal + tax',
            '',
            '; --- Line references (#N) ---',
            '; #N refers to result of line N',
            '100',
            '200',
            '#40 + #41',
            '',
            '; --- Currency ---',
            '$100 * 1.08',
            '€250 + €49.99',
            'hourly = $85/hr',
            'hourly * 40 hr',
            '',
            '; --- Percentages ---',
            '200 * 15%',
            'tip = 18%',
            '$45 * tip',
            '',
            '; --- Base conversions ---',
            '255 to hex',
            '0xFF & 0x0F',
            '1 << 10',
            '',
            '; --- Math functions ---',
            'sqrt(144)',
            'sin(pi / 2)',
            'log(1000)',
            'round(2.5)',
            'round(3.5)',
            '',
            '; --- Data ---',
            '1 GB to MiB',
            '100 Mbit to MB',
            '',
            '; --- Finance ---',
            'fv(0.07, 30, 500)',
          ].join('\n');
        }
      } catch(e) {}
    }
    measureMaxChars();
    runEval(false);
    updateHighlight();
    editor.focus();
  };

  var go = new Go();
  var result = await WebAssembly.instantiateStreaming(
    fetch("ratcalc.wasm"), go.importObject
  );
  go.run(result.instance);
})();
</script>
</body>
</html>
